<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Match & Mint Puzzle 4x4</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #puzzle {
      display: grid;
      grid-template-columns: repeat(4, 100px);
      grid-gap: 5px;
      margin: 20px auto;
    }
    .piece {
      width: 100px;
      height: 100px;
      border: 1px solid #ccc;
      background-size: cover;
      cursor: grab;
    }
    #timer { font-size: 24px; margin-bottom: 10px; }
    #ref { max-width: 300px; margin: 10px auto; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Match & Mint Puzzle 4×4</h1>
  <div id="timer">45</div>
  <div id="puzzle"></div>
  <img id="ref" src="" alt="Reference" />
  <div>
    <button id="connect">Connect Wallet</button>
    <button id="mint" disabled>Mint My Layout</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@nftstorage/nft.storage/dist/bundle.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(async()=>{
  const GITHUB_JSON = 'https://raw.githubusercontent.com/Chiyachita/match-and-mint-assets/main/list.json';
  const TIMER_SEC = 45;
  const NFTSTORAGE_KEY = '04be0e42.406dcb3178d8478585acd3b2f22ddfdf';
  const CONTRACT_ADDR = '0x259C1Da2586295881C18B733Cb738fe1151bD2e5';
  const CONTRACT_ABI = /* ใส่ ABI เต็มที่นี่ */;
  let provider, signer, contract;
  const web3Modal = new window.Web3Modal.default({ cacheProvider:false, providerOptions:{} });

  document.getElementById('connect').onclick = async ()=>{
    try {
      const inst = await web3Modal.connect();
      provider = new ethers.providers.Web3Provider(inst);
      await provider.send('wallet_addEthereumChain',[{
        chainId:'0x279F',chainName:'Monad Testnet',
        rpcUrls:['https://testnet-rpc.monad.xyz'],
        nativeCurrency:{name:'Monad',symbol:'MON',decimals:18}
      }]).catch(()=>{});
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);
      document.getElementById('connect').innerText='Wallet Connected';
      document.getElementById('mint').disabled=false;
    } catch(e) {
      console.error(e);
      alert('เชื่อม Wallet ไม่ติด ลองใหม่');
    }
  };

  // โหลด 16 รูปสุ่ม
  const data = await fetch(GITHUB_JSON).then(r=>r.json());
  const pick = data.sort(()=>0.5-Math.random()).slice(0,16);
  document.getElementById('ref').src = pick[0];
  const puzzle = document.getElementById('puzzle');
  pick.forEach((url)=>{
    const d = document.createElement('div');
    d.className='piece';
    d.style.backgroundImage = `url(${url})`;
    d.draggable = true;
    puzzle.appendChild(d);
  });

  // drag & drop
  let dragSrc=null;
  puzzle.addEventListener('dragstart',e=>{ if(e.target.classList.contains('piece')) dragSrc=e.target; });
  puzzle.addEventListener('dragover',e=>e.preventDefault());
  puzzle.addEventListener('drop',e=>{
    e.preventDefault();
    const tgt=e.target;
    if(tgt.classList.contains('piece') && dragSrc!==tgt){
      [dragSrc.style.backgroundImage, tgt.style.backgroundImage] =
      [tgt.style.backgroundImage, dragSrc.style.backgroundImage];
    }
  });

  // timer
  let time=TIMER_SEC;
  const interval = setInterval(()=>{
    time--; document.getElementById('timer').innerText=time;
    if(time<=0){ clearInterval(interval); mintIt(); }
  },1000);

  // mint
  async function mintIt(){
    document.getElementById('mint').disabled=true;
    const canvas = await html2canvas(puzzle);
    const blob = await new Promise(r=>canvas.toBlob(r,'image/png'));
    const client = new window.NFTStorage.NFTStorage({ token: NFTSTORAGE_KEY });
    const cid = (await client.store({
      image: blob,
      name: 'My Puzzle',
      description: 'Puzzle 4×4 snapshot'
    })).url;
    const tx = await contract.mintNFT(await signer.getAddress(), cid);
    await tx.wait();
    alert('Minted! CID: '+cid);
  }

  document.getElementById('mint').onclick = mintIt;

})();
</script>
</body>
</html>
